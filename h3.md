# H3 - Versionhallinta

Ville Anttila\
Palvelinten hallinta, kevät 2022, Haaga-Helia AMK\
Opettaja: Tero Karvinen\
[Kurssisivu](https://terokarvinen.com/2021/configuration-management-systems-2022-spring/)

## Tiivistelmät ja muistiinpanot

### z) Lue ja tiivistä artikkeli muutamalla ranskalaisella viivalla. Tässä z-alakohdassa ei tarvitse siis tehdä testejä tietokoneella.

* Commonmark contributors: Markdown Reference (huomaa ainakin otsikot risuaidoilla, kappalejako tyhjällä rivillä, sisennys (tab) koodia, lista, linkki, kuva.

* [Markdown](https://commonmark.org/help/)


Markdown on tekstinmuotoilutyyli, jolla voi kirjoittaa yksinkertaisesti muotoiltua tekstiä tavallisella tekstieditorilla. Markdownia tukeva sovellus muuntaa tekstin muotoilun halutuksi.

Esimerkiksi "# kappale" luo uuden kappaleen isolla otsikolla ja "## kappale2" luo alakappaleen pienemmällä otsikolla. Muitakin muotoiluja on, ja Markdownilla voidaan luoda mm. listoja, lihavoida tai kursivoida tekstiä, lisätä koodiblokkeja ja tehdä numeroituja viittauksia linkkeinä muihin sivuihin.

Tämä raportti on kirjoitettu Markdownilla ja siihen on käytetty useita Markdownin ominaisuuksia. Tehtävässä mainitulla sivustolla on myös kätevä interaktiivinen kurssi, joka opettaa Markdownin alkeet. Kurssissa käydään läpi Markdownin eri muotoilut esimerkkien, joita tekijä saa koittaa, kanssa sekä näytetään oikea tapa, mikäli tekijä niin apua tarvitessaan haluaa.

## Varsinaiset tehtävät

### a) MarkDown. Tee tämän tehtävän raportti MarkDownina. Helpointa on tehdä raportti GitHub-varastoon, jolloin md-päätteiset tiedostot muotoillaan automaattisesti. Tyhjä rivi tekee kappalejaon, risuaita ‘#’ tekee otsikon, sisennys merkitsee koodinpätkän.

Tehtävä suoritetaan kirjoittamalla tämä raportti MarkDownina. Raportti on luotu GitHub-varastoon luomalla uusi repo nimeltään h3 GitHubin käyttäjän hallintasivustolla. Luominen tapahtuu klikkaamalla Repositories-sivulla New-painiketta. Tämän jälkeen kysytään repon nimeä ja sitä onko se julkinen vain yksityinen. Näihin annettiin repon nimeksi h3 ja tyypiksi julkinen. Myös lisenssin ja readme.md-tiedoston automaattinen lisäys otettiin käyttöön. Lisenssiksi tuli GPL 2.0 ja readme.md-tiedostoon lisättiin tehtävän nimi ja kurssin nimi.

GitHub loi repoon main-branchin, jonka se otti käyttöön oletuksena. Päätettiin testata asiaa toisella branchilla, toisella nimellä. Aiemmin laajasti käytössä ollut master-branch otettiin nimenä käyttöön toimimalla koneella seuraavasti:

 	mkdir ~/h3 #1
 	cd ~/h3 #2
 	vim h3.md #3
 	git init #4
 	git add . #5
 	git commit #6
 	git remote add origin git@github.com:nokkela/h3.git #7
 	git push -u -f origin master #8 

Aluksi luotiin paikalliselle koneelle projektin hakemisto, joka tässä tapauksessa oli nimeltään h3. Siirryttiin hakemistoon ja kirjoitettiin sisältöä projektin eli tehtävän h3.md-tiedostoon. Seuraavaksi alustettiin repo, lisättiin sinne kaikki hakemistossa olevat tiedostot, tehtiin commit ja kirjoitettiin ensimmäisen commitin tiedot projektia eli tehtävää koskien. Koska repo oli aiemmin luotu GitHubiin, piti paikalliselle koneelle vielä kertoa se, minne se tätä projektia on puskemassa. Kohdassa seitsemän annettiin projektin GitHub-osoite ja viimeisellä rivillä pushattiin kaikki projetiin master-nimiselle branchille. Main branch jäi elämään omaa elämäänsä. 

[Ohje ja referenssi](https://www.digitalocean.com/community/tutorials/how-to-push-an-existing-project-to-github)

**Lisäys 20.04.2022**
Korjattiin tekstissä viittaus komennon numeroon otettaessa repoa käyttöön paikallisella koneella.


### b) Pull first. Tee useita muutoksia git-varastoosi. Tee muutama muutos, jossa yksi commit koskee useampaa tiedostoa. Anna hyvä kuvaukset (commit message), yksi englanninkielinen lause imperatiivissa (määräysmuodossa) "Add top level menu to Foobar synchronizer"

Tehdään projektille h3 myös readme.md-tiedosto, jolloin annettu tehtävä voidaan suorittaa.

Editoidaan vimillä tiedostoa readme.md projektin h3-hakemistossa. Tehdään commit ja pushataan muutokset GitHubiin.
	
	cd ~/h3 # Varmistetaan että olemme oikeassa hakemistoissa
	vim readme.md h3.md # Tehdään varsinainen tekstieditointi
	git add . && git commit && git pull && git push # Lisätään tiedostot, tehdään commit ja vedetään tavan vuoksi muutokset sisään ja lopulta pushataan muokatut tiedostot GitHubiin

Muutokset näkyvät Gitin logeissa committ messageina.

	commit 9163ca03435e9942dba91992a7da34b889f4bc3f (HEAD -> master, origin/master)
	Author: Ville Anttila <ville@argon>
	Date:   Mon Apr 18 23:15:48 2022 +0300
		
	Add some more text to h3.md again
	
	commit bd1e921afe433be48b52201a8cf6acf9af3420d6
	Author: Ville Anttila <ville@argon>
	Date:   Mon Apr 18 23:12:22 2022 +0300

	Add readme.md for the project and more substance for h3.md

Komennolla *git log* saaduista tiedoista ilmenee, että Ville Anttila on muokannut omien sanojensa mukaan useampaa tiedostoa.


### c) Kaikki kirjataan. Näytä omalla git-varastollasi esimerkit komennoista ‘git log’, ‘git diff’ ja ‘git blame’. Selitä tulokset.

*git log* näyttää commitlogin, joka kertoo jokaisen repoon muutoksia tehneen käyttäjän commitin ja kuvauksen
Committeja on tehnyt vain yksi käyttäjä, joka on kirjoitellut niihin mielestään sopivia kuvauksia, jotka liittyvät kyseisen tehtävän edistymiseen.

*git diff x y* kertoo esimerkiksi eroavaisuudet kahden commitin välillä. 
Esimerkiksi *git diff bf9e2181b334ec65b666af6b027102a39d973223 b7e8d3d5e00fcf5c57815f4778ace7fd2ea31d68*
Tässä kohtaa on lisätty uusi tehtäväkohta c markdown-tiedostoon.

*git blame file* kertoo mitä muutoksia annettuun tiedostoon on tehty ja kuka ne on tehnyt.
Esimerkiksi *git blame ~/h3/h3.md* kertoo kuka on tehnyt mitäkin tiedostoon h3.
Nähdään, että Ville Anttila on tehnyt tiedostoon useita muutoksia.

Logit näistä ovat repon txt-hakemistossa. Voin näyttää ne sieltä.
Lähteet: man git log|diff|blame


### e) Huppis! Tee tyhmä muutos gittiin, älä tee commit:tia. Tuhoa huonot muutokset ‘git reset --hard’. Huomaa, että tässä toiminnossa ei ole peruutusnappia.

Tuhotaan readme.md ja resetoidaan repo. *man git reset* kertoo komennon *git reset --hard* asettavan repon viimeisimmän commitin tilaan. Katsotaan.

	ville@argon h3 %rm readme.md                                            [0 12:17:11 22-04-19 (INS)]
	ville@argon h3 %ls                                                      [0 12:17:15 22-04-19 (INS)]
	h3.md  img  txt
	ville@argon h3 %git reset --hard                                        [0 12:17:18 22-04-19 (INS)]
	HEAD is now at 5d3ed93 Add section d to h3 and work on the task
	ville@argon h3 %ls                                                      [0 12:17:23 22-04-19 (INS)]	
	h3.md  img  readme.md  txt

Ja kyllä vain, git on palauttanut tilanteen ennalleen ja korjannut huolimattoman rm-komennon käytön.


### f) Formula. Tee uusi salt-tila (formula, moduli, infraa koodina). (Eli uusi tiedosto esim. /srv/salt/terontila/init.sls). Voit tehdä ihan yksinkertaisen parin funktion (pkg, file...) tilan, tai edistyneemmin asentaa ja konfiguroida minkä vain uuden ohjelman: demonin, työpöytäohjelman tai komentokehotteesta toimivan ohjelman. Käytä tarvittaessa ‘find -printf “%T+ %p\n”|sort’ löytääksesi uudet asetustiedostot.

Tehdään aluksi yksinkertainen salt-tila, jota mahdollisesti parannellaan jälkikäteen, kun päästään dösästä pois.

	openvpn_package:
	  pkg.installed:
	    - name: openvpn
	openvpn_service:
	  service.running:
	    - name: openvpn
	    - watch:
	      - file: /etc/openvpn/neptunium.conf
	openvpn_config:
	  file.managed:
	    - name: /etc/openvpn/neptunium.conf
	    - source: salt://openvpn/neptunium.conf
	    - user: root
	    - perms: 0600
	user_check:
	  user.present:
	    - name: ville
	    - home: /home/ville/
	    - shell: /bin/zsh

**Lisäys 20.04.2022** 
Tilaa ei ole testattu ja siinä on virheitä.
Teron palautteen perusteella korjattu tila alla:

	openvpn:
	  pkg.installed
	/etc/openvpn/neptunium.conf:
	  file.managed:
	    - source: salt://openvpn/neptunium.conf
	    - user: root
	    - group: root
	    - mode: 0600
	openvpn.service:
	  service.running:
	    - watch:
	      - file: /etc/openvpn/neptunium.conf
	user_check:
	  user.present:
	    - name: ville
	    - home: /home/ville/
	    - shell: /bin/zsh
	    - uid: 1000
	    - gid: 1000

Palautteen perusteella yksinkertaistettiin koodia, asetettiin neptunium.conf -tiedoston puskeminen ennen palvelun tarkistusta. OpenVPN:n avaimet lisätään asetustiedostoon base64-muodossa.

Yllä olevan alemman tilan tulisi (testausta ei vielä ole tehty) asentaa minioneilla openvpn ja saada vpn niillä käyttöön.

---
Salt-tila varmistaa ensin, että paketti *openvpn* on asennettu.
*openvpn.service* -tila tarkistaa, että openvpn-palvelu on käynnissä ja tarkkaillaan sen asetustiedostoa. Muuttunut asetustiedosto aiheuttaa palvelun uudelleenkäynnistyksen. 
*/etc/openvpn/neptunium.conf* -funktiossa varmistetaan openvpn-palvelun asetustiedoston paikka eli nimi, sisältö sekä käyttöoikeudet. Tiedoston muuttuessa Saltin versiosta Salt korvaa tiedoston ja käynnistää palvelun uudelleen.
Viimeksi tarkistetaan, että käyttäjä nimeltään *ville*, jolla on kotihakemisto */home/ville* ja komentotulkkina *zsh*

Jos aikaa jää, kirjoitan tilaan lisää asioita kuten openvpn-palvelun avainten hallinnan.
